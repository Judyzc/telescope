<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Results - Telescope</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <nav class="top-nav">
    <div class="nav-brand">
      <span class="logo">üî≠</span>
      <span class="brand-name">Telescope</span>
    </div>
    <div class="nav-links">
      <a href="/">Home</a>
      <a href="/upload.html" class="active">Upload</a>
      <a href="/results.html">Results</a>
    </div>
  </nav>

  <main class="container">
    <header class="page-header">
      <h1>Upload Test Results</h1>
      <p class="subtitle">Upload a ZIP file generated by Telescope CLI</p>
    </header>

    <section class="section">
      <div class="upload-area" id="upload-area">
        <div class="upload-icon">üìÅ</div>
        <p class="upload-text">Drag and drop your ZIP file here</p>
        <p class="upload-subtext">or</p>
        <label class="upload-button">
          <input type="file" id="file-input" accept=".zip" hidden>
          Choose File
        </label>
      </div>

      <div class="upload-status" id="upload-status" hidden>
        <div class="status-icon" id="status-icon">‚è≥</div>
        <p class="status-text" id="status-text">Uploading...</p>
        <div class="progress-bar" id="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <div class="upload-success" id="upload-success" hidden>
        <div class="success-icon">‚úÖ</div>
        <p class="success-text">Upload complete!</p>
        <a href="#" class="view-results-btn" id="view-results-btn">View Results</a>
      </div>

      <div class="upload-error" id="upload-error" hidden>
        <div class="error-icon">‚ùå</div>
        <p class="error-text" id="error-text">Upload failed</p>
        <button class="retry-btn" id="retry-btn">Try Again</button>
      </div>
    </section>

    <section class="section">
      <h2>How to generate a ZIP</h2>
      <p>Run Telescope with the <code>--zip</code> flag to generate an uploadable ZIP file:</p>
      <div class="code-block">
        <pre><code>npx @cloudflare/telescope -u https://example.com -b chrome --zip</code></pre>
      </div>
      <p>The ZIP file will be created in the <code>results/</code> directory with the test ID as the filename.</p>
    </section>
  </main>

  <footer class="footer">
    <p>Telescope by Cloudflare</p>
  </footer>

  <script>
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const uploadStatus = document.getElementById('upload-status');
    const uploadSuccess = document.getElementById('upload-success');
    const uploadError = document.getElementById('upload-error');
    const statusText = document.getElementById('status-text');
    const statusIcon = document.getElementById('status-icon');
    const progressFill = document.getElementById('progress-fill');
    const viewResultsBtn = document.getElementById('view-results-btn');
    const errorText = document.getElementById('error-text');
    const retryBtn = document.getElementById('retry-btn');

    // Drag and drop handlers
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].name.endsWith('.zip')) {
        handleUpload(files[0]);
      } else {
        showError('Please upload a ZIP file');
      }
    });

    // File input handler
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleUpload(e.target.files[0]);
      }
    });

    // Retry button
    retryBtn.addEventListener('click', () => {
      resetUpload();
    });

    function resetUpload() {
      uploadArea.hidden = false;
      uploadStatus.hidden = true;
      uploadSuccess.hidden = true;
      uploadError.hidden = true;
      fileInput.value = '';
    }

    function showError(message) {
      uploadArea.hidden = true;
      uploadStatus.hidden = true;
      uploadSuccess.hidden = true;
      uploadError.hidden = false;
      errorText.textContent = message;
    }

    async function handleUpload(file) {
      uploadArea.hidden = true;
      uploadStatus.hidden = false;
      uploadSuccess.hidden = true;
      uploadError.hidden = true;
      
      statusText.textContent = `Uploading ${file.name}...`;
      progressFill.style.width = '0%';

      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Upload failed');
        }

        const result = await response.json();
        
        // Show success
        uploadStatus.hidden = true;
        uploadSuccess.hidden = false;
        viewResultsBtn.href = `/results/${result.testId}/overview`;
        
      } catch (error) {
        showError(error.message);
      }
    }

    // Simulate progress (since fetch doesn't give us upload progress easily)
    let progressInterval;
    function startProgress() {
      let progress = 0;
      progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        progressFill.style.width = `${progress}%`;
      }, 200);
    }

    function stopProgress() {
      clearInterval(progressInterval);
      progressFill.style.width = '100%';
    }
  </script>
</body>
</html>
